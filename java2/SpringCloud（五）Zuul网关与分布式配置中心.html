<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修SpringCloud（五）Zuul网关与分布式配置中心' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>SpringCloud（五）Zuul网关与分布式配置中心</center></div><div class='banquan'>原文出处:本文由博客园博主茶底世界提供。<br/>
原文连接:https://www.cnblogs.com/yuanqinnan/p/11568787.html</div><br>
    <p class="md-end-block"><span>在 Spring Cloud 微服务系统中，一种常见的负载均衡方式是，客户端的请求首先经过负载均衡（Ngnix），再到达服务网关（Zuul 集群），然后再到具体的服务。服务统一注册到高可用的服务注册中心集群，服务的所有的配置文件由配置服务管理，配置服务的配置文件放在 GIT 仓库，方便开发人员随时改配置。</span></p>
<h2 class="md-end-block">一、Zuul</h2>
<p class="md-end-block">Zuul包含了对请求的路由和过滤两个最主要的功能：<span class="md-softbreak">&nbsp;其中路由功能负责将外部请求转发到具体的微服务实例上，是实现外部访问统一入口的基础而过滤器功能则负责对请求的处理过程进行干预，是实现请求校验、服务聚合等功能的基础.</span></p>
<p class="md-end-block">Zuul和Eureka进行整合，将Zuul自身注册为Eureka服务治理下的应用，同时从Eureka中获得其他微服务的消息，也即以后的访问微服务都是通过Zuul跳转后获得。Zuul服务最终还是会注册进Eureka。</p>
<p class="md-end-block md-focus">总体来说Zuul提供代理、路由、过滤三大功能。</p>
<h3 class="md-end-block md-focus"><span>1.1 创建Zuul项目</span></h3>
<p><span>创建一个spring-cloud-learn-zuul项目，创建方式与之前相同，pom.xml文件如下：</span></p>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version="1.0" encoding="UTF-8"</span><span style="color: #0000ff;">?&gt;</span>
<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">project </span><span style="color: #ff0000;">xmlns</span><span style="color: #0000ff;">="http://maven.apache.org/POM/4.0.0"</span><span style="color: #ff0000;"> xmlns:xsi</span><span style="color: #0000ff;">="http://www.w3.org/2001/XMLSchema-instance"</span><span style="color: #ff0000;">
         xsi:schemaLocation</span><span style="color: #0000ff;">="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">modelVersion</span><span style="color: #0000ff;">&gt;</span>4.0.0<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">modelVersion</span><span style="color: #0000ff;">&gt;</span>

    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">parent</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>com.yuanqinnan<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>spring-cloud-learn-parent<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">version</span><span style="color: #0000ff;">&gt;</span>1.0.0-SNAPSHOT<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">version</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">parent</span><span style="color: #0000ff;">&gt;</span>

    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>spring-cloud-learn-zuul<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">packaging</span><span style="color: #0000ff;">&gt;</span>jar<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">packaging</span><span style="color: #0000ff;">&gt;</span>

    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">name</span><span style="color: #0000ff;">&gt;</span>spring-cloud-learn-zuul<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">name</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">dependencies</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;"> Spring Boot Begin </span><span style="color: #008000;">--&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>org.springframework.boot<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>spring-boot-starter-web<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>org.springframework.boot<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>spring-boot-starter-tomcat<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>org.springframework.boot<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>spring-boot-starter-actuator<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>org.springframework.boot<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>spring-boot-starter-test<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">scope</span><span style="color: #0000ff;">&gt;</span>test<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">scope</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;"> Spring Boot End </span><span style="color: #008000;">--&gt;</span>

        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;"> Spring Cloud Begin </span><span style="color: #008000;">--&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>org.springframework.cloud<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>spring-cloud-starter-netflix-eureka-server<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>org.springframework.cloud<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>spring-cloud-starter-netflix-zuul<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;"> Spring Cloud End </span><span style="color: #008000;">--&gt;</span>
    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">dependencies</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">project</span><span style="color: #0000ff;">&gt;</span></code></pre>

<p>新建启动类ZuulApplication，增加@EnableZuulProxy注解</p>
<src class="cnblogs_code">
<pre><code><span style="color: #000000;">@SpringBootApplication
@EnableEurekaClient
@EnableZuulProxy
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> ZuulApplication {
    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {
        SpringApplication.run(ZuulApplication.</span><span style="color: #0000ff;">class</span><span style="color: #000000;">, args);
    }
}</span></code></pre>

<p>application.yml配置如下：</p>
<src class="cnblogs_code">
<pre><code><span style="color: #000000;">spring:
  application:
    name: spring-cloud-learn-zuul

server:
  port: 8769

eureka:
  client:
    serviceUrl:
      defaultZone: http://localhost:8761/eureka/

zuul:
  routes:
    api-a:
      path: /api/a/**
      serviceId: spring-cloud-learn-consumer-dept-ribbon
    api-b:
      path: /api/b/**
      serviceId: spring-cloud-learn-consumer-dept-feign</span></code></pre>

<p class="md-end-block"><span>这个配置文件也很好理解，主要是配置路由：</span></p>
<ul class="ul-list" data-mark="-">
<li class="md-list-item">
<p class="md-end-block"><span>以 <span><code>/api/a</code><span> 开头的请求都转发给 <span><code>spring-cloud-learn-consumer-dept-ribbon</code><span> 服务</span></span></span></span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block"><span>以 <span><code>/api/b</code><span> 开头的请求都转发给 <span><code>spring-cloud-learn-consumer-dept-feign</code><span> 服务</span></span></span></span></span></p>
</li>
</ul>
<p class="md-end-block"><span>然后再启动之前的所有项目</span></p>
<p class="md-end-block"><span>打开浏览器访问：<span class="md-link"><a href="http://localhost:8769/api/a/hi?message=HelloZuul">http://localhost:8769/api/a/hi?message=HelloZuul</a><span> 浏览器显示</span></span></span></p>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span>Hi，your message is :"HelloZuul" i am from port：8763</span></code></pre>
<p class="md-end-block md-focus"><span>打开浏览器访问：<span class="md-link"><a href="http://localhost:8769/api/a/hi?message=HelloZuul">http://localhost:8769/api/a/hi?message=HelloZuul</a><span> 浏览器显示</span></span></span></p>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span>Hi，your message is : HelloZuul i am from port : 8763</span></code></pre>
<h3><span class="md-expand">1.2 失败时的回调</span></h3>
<p><span class="md-expand">由于网络震荡或者一些未知原因，可能会导致网关调用失败，这个时候我们需要配置一个网关路由失败时的回调，继承FallbackProvider</span></p>
<src class="cnblogs_code">
<pre><code><span style="color: #000000;">@Component
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> ConsumerDeptFeignFallbackProvider <span style="color: #0000ff;">implements</span><span style="color: #000000;"> FallbackProvider {

    @Override
    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> String getRoute() {
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> ServiceId，如果需要所有调用都支持回退，则 return "*" 或 return null</span>
        <span style="color: #0000ff;">return</span> "spring-cloud-learn-consumer-dept-feign"<span style="color: #000000;">;
    }
     </span><span style="color: #008000;">/**</span><span style="color: #008000;">
     　* 如果请求服务失败，则返回指定的信息给调用者
     　* </span><span style="color: #808080;">@param</span><span style="color: #008000;">
     　* </span><span style="color: #808080;">@return</span><span style="color: #008000;">
       * @date
     　</span><span style="color: #008000;">*/</span><span style="color: #000000;">
    @Override
    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> ClientHttpResponse fallbackResponse(String route, Throwable cause) {
        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> ClientHttpResponse() {
            </span><span style="color: #008000;">/**</span><span style="color: #008000;">
             * 网关向 api 服务请求失败了，但是消费者客户端向网关发起的请求是成功的，
             * 不应该把 api 的 404,500 等问题抛给客户端
             * 网关和 api 服务集群对于客户端来说是黑盒
             * </span><span style="color: #808080;">@return</span><span style="color: #008000;">
             * </span><span style="color: #808080;">@throws</span><span style="color: #008000;"> IOException
             </span><span style="color: #008000;">*/</span><span style="color: #000000;">
            @Override
            </span><span style="color: #0000ff;">public</span> HttpStatus getStatusCode() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> IOException {
                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> HttpStatus.OK;
            }

            @Override
            </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span> getRawStatusCode() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> IOException {
                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> HttpStatus.OK.value();
            }

            @Override
            </span><span style="color: #0000ff;">public</span> String getStatusText() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> IOException {
                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> HttpStatus.OK.getReasonPhrase();
            }

            @Override
            </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> close() {

            }

            @Override
            </span><span style="color: #0000ff;">public</span> InputStream getBody() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> IOException {
                ObjectMapper objectMapper </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> ObjectMapper();
                Map</span>&lt;String, Object&gt; map = <span style="color: #0000ff;">new</span> HashMap&lt;&gt;<span style="color: #000000;">();
                map.put(</span>"status", 200<span style="color: #000000;">);
                map.put(</span>"message", "无法连接，请检查您的网络"<span style="color: #000000;">);
                </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> ByteArrayInputStream(objectMapper.writeValueAsString(map).getBytes("UTF-8"<span style="color: #000000;">));
            }

            @Override
            </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> HttpHeaders getHeaders() {
                HttpHeaders headers </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> HttpHeaders();
                </span><span style="color: #008000;">//</span><span style="color: #008000;"> 和 getBody 中的内容编码一致</span>
<span style="color: #000000;">                headers.setContentType(MediaType.APPLICATION_JSON_UTF8);
                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> headers;
            }
        };
    }
}</span></code></pre>

<h3 class="md-end-block md-heading md-focus"><span class="md-expand">1.3 过滤功能</span></h3>
<p class="md-end-block"><span>Zuul 不仅仅只是路由，还有很多强大的功能，本节演示一下它的服务过滤功能，比如用在安全验证方面。</span></p>
<p class="md-end-block"><span>来创建下过滤器功能：只要继承 <span><strong>ZuulFilter</strong><span> 类并在类上增加 <span><strong>@Component</strong><span> 注解就可以使用服务过滤功能了</span></span></span></span></span></p>
<src class="cnblogs_code">
<pre><code><span style="color: #000000;">@Component
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> LoginFilter <span style="color: #0000ff;">extends</span><span style="color: #000000;"> ZuulFilter {
    </span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> Logger logger = LoggerFactory.getLogger(LoginFilter.<span style="color: #0000ff;">class</span><span style="color: #000000;">);
     </span><span style="color: #008000;">/**</span><span style="color: #008000;">
      * 配置过滤类型，有四种不同生命周期的过滤器类型
      * 1. pre：路由之前
      * 2. routing：路由之时
      * 3. post：路由之后
      * 4. error：发送错误调用
     </span><span style="color: #008000;">*/</span><span style="color: #000000;">
    @Override
    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> String filterType() {
        </span><span style="color: #0000ff;">return</span> "pre"<span style="color: #000000;">;
    }
     </span><span style="color: #008000;">/**</span><span style="color: #008000;">
     　* 配置过滤的顺序
     　</span><span style="color: #008000;">*/</span><span style="color: #000000;">
    @Override
    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> filterOrder() {
        </span><span style="color: #0000ff;">return</span> 0<span style="color: #000000;">;
    }

     </span><span style="color: #008000;">/**</span><span style="color: #008000;">
     　* 配置是否需要过滤：true/需要，false/不需要
     　</span><span style="color: #008000;">*/</span><span style="color: #000000;">
    @Override
    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> shouldFilter() {
        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">;
    }
     </span><span style="color: #008000;">/**</span><span style="color: #008000;">
     　* 过滤器的具体业务代码
     　* </span><span style="color: #808080;">@param</span>
     　<span style="color: #008000;">*/</span><span style="color: #000000;">
    @Override
    </span><span style="color: #0000ff;">public</span> Object run() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> ZuulException {
        RequestContext context </span>=<span style="color: #000000;"> RequestContext.getCurrentContext();
        HttpServletRequest request </span>=<span style="color: #000000;"> context.getRequest();
        logger.info(</span>"{} &gt;&gt;&gt; {}"<span style="color: #000000;">, request.getMethod(), request.getRequestURL().toString());
        String token </span>= request.getParameter("token"<span style="color: #000000;">);
        </span><span style="color: #0000ff;">if</span> (token == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
            logger.warn(</span>"Token is empty"<span style="color: #000000;">);
            context.setSendZuulResponse(</span><span style="color: #0000ff;">false</span><span style="color: #000000;">);
            context.setResponseStatusCode(</span>401<span style="color: #000000;">);
            </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {
                context.getResponse().getWriter().write(</span>"Token is empty"<span style="color: #000000;">);
            } </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) {
            }
        } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
            logger.info(</span>"OK"<span style="color: #000000;">);
        }
        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;
    }</span></code></pre>

<p class="md-end-block" style="box-sizing: border-box; orphans: 4; margin: 0.8em 0px; white-space: pre-wrap; width: inherit; position: relative; color: #333333; font-family: 'Open Sans', 'Clear Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 16px;"><span style="box-sizing: border-box;">这里的四个方法：</span></p>
<ol class="ol-list" style="box-sizing: border-box; margin-top: 0.8em; margin-right: 0px; margin-bottom: 0.8em; padding-left: 30px; position: relative; color: #333333; font-family: 'Open Sans', 'Clear Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 16px;">
<li class="md-list-item" style="box-sizing: border-box; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; position: relative;">
<p class="md-end-block" style="box-sizing: border-box; orphans: 4; margin: 0px 0px 0.5rem; white-space: pre-wrap; position: relative;"><span style="box-sizing: border-box;">filterType：返回一个字符串代表过滤器的类型，在 Zuul 中定义了四种不同生命周期的过滤器类型</span></p>
<span style="box-sizing: border-box;">pre：路由之前</span>
<p class="md-end-block" style="box-sizing: border-box; orphans: 4; margin: 0.5rem 0px; white-space: pre-wrap; position: relative;"><span style="box-sizing: border-box;">routing：路由之时</span></p>
<p class="md-end-block" style="box-sizing: border-box; orphans: 4; margin: 0.5rem 0px; white-space: pre-wrap; position: relative;"><span style="box-sizing: border-box;">post： 路由之后</span></p>
<p class="md-end-block" style="box-sizing: border-box; orphans: 4; margin: 0.5rem 0px; white-space: pre-wrap; position: relative;"><span style="box-sizing: border-box;">error：发送错误调用</span></p>
</li>
<li class="md-list-item" style="box-sizing: border-box; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; position: relative;">
<p class="md-end-block" style="box-sizing: border-box; orphans: 4; margin: 0px 0px 0.5rem; white-space: pre-wrap; position: relative;"><span style="box-sizing: border-box;"> filterOrder：过滤的顺序</span></p>
</li>
<li class="md-list-item" style="box-sizing: border-box; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; position: relative;">
<p class="md-end-block" style="box-sizing: border-box; orphans: 4; margin: 0px 0px 0.5rem; white-space: pre-wrap; position: relative;"><span style="box-sizing: border-box;">shouldFilter：是否需要过滤，这里是 </span><span style="box-sizing: border-box;"><strong style="box-sizing: border-box;">true</strong></span><span style="box-sizing: border-box;">，需要过滤</span></p>
</li>
<li class="md-list-item" style="box-sizing: border-box; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; position: relative;">
<p class="md-end-block" style="box-sizing: border-box; orphans: 4; margin: 0px 0px 0.5rem; white-space: pre-wrap; position: relative;"><span style="box-sizing: border-box;">run：过滤器的具体业务代码</span></p>
</li>
</ol>
<p class="md-end-block" style="box-sizing: border-box; orphans: 4; margin: 0.8em 0px; white-space: pre-wrap; width: inherit; position: relative; color: #333333; font-family: 'Open Sans', 'Clear Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 16px;"><span style="box-sizing: border-box;">测试下:</span><span class="md-link" style="box-sizing: border-box; word-break: break-all;"><a style="box-sizing: border-box; cursor: pointer; color: #4183c4; -webkit-user-drag: none;" href="http://localhost:8769/api/a/hi?message=HelloZuul">http://localhost:8769/api/a/hi?message=HelloZuul</a></span><span style="box-sizing: border-box;"> 网页显示</span></p>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span style="box-sizing: border-box; padding-right: 0.1px;">Token is empty</span></code></pre>
<p class="md-end-block" style="box-sizing: border-box; orphans: 4; margin: 0.8em 0px; white-space: pre-wrap; width: inherit; position: relative; color: #333333; font-family: 'Open Sans', 'Clear Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 16px;"><span class="md-link" style="box-sizing: border-box; word-break: break-all;"><a style="box-sizing: border-box; cursor: pointer; color: #4183c4; -webkit-user-drag: none;" href="http://localhost:8769/api/b/hi?message=HelloZuul&amp;token=123">http://localhost:8769/api/b/hi?message=HelloZuul&amp;token=123</a></span><span style="box-sizing: border-box;"> 网页显示</span></p>
<p class="md-end-block" style="box-sizing: border-box; orphans: 4; margin: 0.8em 0px; white-space: pre-wrap; width: inherit; position: relative; color: #333333; font-family: 'Open Sans', 'Clear Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 16px;"><span style="box-sizing: border-box;">Hi，your message is :"HelloZuul" i am from port：8763</span></p>
<p>&nbsp;</p>
<h2><span style="box-sizing: border-box;">二、分布式配置中心</span></h2>
<p><span style="box-sizing: border-box;">在分布式系统中，由于服务数量巨多，为了方便服务配置文件统一管理，实时更新，所以需要分布式配置中心组件。在 Spring Cloud 中，有分布式配置中心组件 Spring Cloud Config ，它支持配置服务放在配置服务的内存中（即本地），也支持放在远程 Git 仓库中。在 Spring Cloud Config 组件中，分两个角色，一是 Config Server，二是 Config Client。</span></p>
<h3><span style="box-sizing: border-box;">2.1&nbsp;</span><span class="md-expand">Config Server项目</span></h3>
<p><span class="md-expand">创建项目的方式与之前相同，新建spring-cloud-learn-config项目，pom.xml文件如下：</span></p>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version="1.0" encoding="UTF-8"</span><span style="color: #0000ff;">?&gt;</span>
<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">project </span><span style="color: #ff0000;">xmlns</span><span style="color: #0000ff;">="http://maven.apache.org/POM/4.0.0"</span><span style="color: #ff0000;"> xmlns:xsi</span><span style="color: #0000ff;">="http://www.w3.org/2001/XMLSchema-instance"</span><span style="color: #ff0000;">
         xsi:schemaLocation</span><span style="color: #0000ff;">="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">modelVersion</span><span style="color: #0000ff;">&gt;</span>4.0.0<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">modelVersion</span><span style="color: #0000ff;">&gt;</span>

    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">parent</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>com.yuanqinnan<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>spring-cloud-learn-parent<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">version</span><span style="color: #0000ff;">&gt;</span>1.0.0-SNAPSHOT<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">version</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">parent</span><span style="color: #0000ff;">&gt;</span>

    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>spring-cloud-learn-config<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">packaging</span><span style="color: #0000ff;">&gt;</span>jar<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">packaging</span><span style="color: #0000ff;">&gt;</span>

    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">name</span><span style="color: #0000ff;">&gt;</span>spring-cloud-learn-config<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">name</span><span style="color: #0000ff;">&gt;</span>

    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">dependencies</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;"> Spring Boot Begin </span><span style="color: #008000;">--&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>org.springframework.boot<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>spring-boot-starter-web<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>org.springframework.boot<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>spring-boot-starter-tomcat<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>org.springframework.boot<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>spring-boot-starter-actuator<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>org.springframework.boot<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>spring-boot-starter-test<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">scope</span><span style="color: #0000ff;">&gt;</span>test<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">scope</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;"> Spring Boot End </span><span style="color: #008000;">--&gt;</span>

        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;"> Spring Cloud Begin </span><span style="color: #008000;">--&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>org.springframework.cloud<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>spring-cloud-config-server<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>org.springframework.cloud<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>spring-cloud-starter-netflix-eureka-server<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;"> Spring Cloud End </span><span style="color: #008000;">--&gt;</span>
    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">dependencies</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">project</span><span style="color: #0000ff;">&gt;</span></code></pre>

<p><span class="md-expand">新建启动项目ConfigApplication，增加<span><strong><span>@EnableConfigServer</span></strong><span>注解</span></span></span></p>
<src class="cnblogs_code">
<pre><code><span style="color: #000000;">@SpringBootApplication
@EnableConfigServer
@EnableEurekaClient
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> ConfigApplication {
    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {
        SpringApplication.run(ConfigApplication.</span><span style="color: #0000ff;">class</span><span style="color: #000000;">, args);
    }
}</span></code></pre>

<p><span class="md-expand"><strong><span>application.yml</span></strong><span class="md-expand"> 配置文件</span></span></p>
<src class="cnblogs_code">
<pre><code><span style="color: #000000;">spring:
  application:
    name: spring-cloud-learn-config
  cloud:
    config:
      label: master
      server:
        git:
          uri: https://github.com/yuanqinnan/spring-cloud-config
          search-paths: respo
          username:
          password:

server:
  port: 8888

eureka:
  client:
    serviceUrl:
      defaultZone: http://localhost:8761/eureka/</span></code></pre>

<p class="md-end-block"><span>这里注意的地方是端口号不要修改，使用8888，如要修改创建一个bootstrap.properties文件进行修改，原因是 <span><code>bootstrap</code><span> 开头的配置文件会被优先加载和配置，切记。</span></span></span></p>
<p class="md-end-block"><span>这里的配置文件也比较好理解，相关配置说明，如下：</span></p>
<ul class="ul-list" data-mark="-">
<li class="md-list-item">
<p class="md-end-block"><span><code>spring.cloud.config.label</code><span>：配置仓库的分支</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block"><span><code>spring.cloud.config.server.git.uri</code><span>：配置 Git 仓库地址（GitHub、GitLab、码云 ...）</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block"><span><code>spring.cloud.config.server.git.search-paths</code><span>：配置仓库路径（存放配置文件的目录）</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block"><span><code>spring.cloud.config.server.git.username</code><span>：访问 Git 仓库的账号</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block"><span><code>spring.cloud.config.server.git.password</code><span>：访问 Git 仓库的密码</span></span></p>
</li>
</ul>
<p class="md-end-block"><span>注意事项：</span></p>
<ul class="ul-list" data-mark="-">
<li class="md-list-item">
<p class="md-end-block"><span>如果使用 GitLab 作为仓库的话，<span><code>git.uri</code><span> 需要在结尾加上 <span><code>.git</code><span>，GitHub 则不用</span></span></span></span></span></p>
</li>
</ul>
<p class="md-end-block"><span>我们想要测试的话，先在自己的github上新建一个仓库，并新增respo文件夹（存放配置文件的目录），然后新增一个配置文件consumer-dept-feign.yml(这个是配置feign项目的)即可，然后我们就可以看看效果：</span></p>
<p class="md-end-block"><span>访问路径为：<span class="md-link"><a href="http://localhost:8888/consumer-dept-feign/master">http://localhost:8888/consumer-dept-feign/master</a><span> 这里路径也好理解，这里的是配合文件名称加上分支名称</span></span></span></p>
<p class="md-end-block"><span><img src="./images/SpringCloud（五）Zuul网关与分布式配置中心0.png" alt="" /></span></p>
<p class="md-end-block">&nbsp;</p>
<p class="md-end-block"><span>在实际开发过程中，我们一般有三个环境，开发、测试、生产，而我们一般会在配置文件后加后缀来区分，如consumer-dept-feign-dev.yml，这个时候的访问路径就是<span class="md-link"><a href="http://localhost:8888/consumer-dept-feign/dev/master">http://localhost:8888/consumer-dept-feign/dev/master</a><span>,路径地址增加环境地址，为了方便测试，再上传一个consumer-dept-feign-prod.yml，作为正式环境的配置，只修改一下端口号（8766）即可。</span></span></span></p>
<p class="md-end-block md-focus"><span class="md-expand">这里看出来，我们的feign项目的配置文件已经换成配置中心的，那现在可以去改造feign，让他去取配置中心的配置。</span></p>
<h3><span class="md-expand">2.2 改造Config Client项目</span></h3>
<p><span class="md-expand">因为我们刚刚上传了spring-cloud-learn-consumer-dept-feign项目的配置文件，现在拿来做下实践，第一步还是添加依赖：</span></p>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>org.springframework.cloud<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>spring-cloud-starter-config<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span></code></pre>

<p>启动类没有变化，只需修改配置文件：</p>
<src class="cnblogs_code">
<pre><code><span style="color: #000000;">spring:
  cloud:
    config:
      uri: http://localhost:8888
      name: consumer-dept-feign
      label: master
      profile: dev</span></code></pre>

<p class="md-end-block"><span>我们看到这里只保留了cloud.config下的相关配置，因为其他所有的配置，我们都可以去云配置中找，这里的配置说明如下：</span></p>
<p class="md-end-block"><span>相关配置说明，如下：</span></p>
<ul class="ul-list" data-mark="-">
<li class="md-list-item">
<p class="md-end-block"><span><code>spring.cloud.config.uri</code><span>：配置服务中心的网址</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block"><span><code>spring.cloud.config.name</code><span>：配置文件名称的前缀</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block"><span><code>spring.cloud.config.label</code><span>：配置仓库的分支</span></span></p>
</li>
<li class="md-list-item">
<pre class="md-fences mock-cm md-end-block">spring.cloud.config.profile
</code></pre>
<p class="md-end-block"><span>：配置文件的环境标识</span></p>
<ul class="ul-list" data-mark="-">
<li class="md-list-item">
<p class="md-end-block"><span>dev：表示开发环境</span></p>
</li>
<li class="md-list-item">
<p class="md-end-block"><span>test：表示测试环境</span></p>
</li>
<li class="md-list-item">
<p class="md-end-block"><span>prod：表示生产环境</span></p>
</li>
</ul>
</li>
</ul>
<p class="md-end-block"><span>现在只要能够启动feign项目，就说明配置中心生效了，我们启动一下，一切顺利，可以启动成功。当我们修改 profile为prod时，启动的就是8766端口。</span></p>
<p>&nbsp;</p>

</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>